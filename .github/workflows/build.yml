name: Build AzerothCore Playerbots (Artifact Only)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Build in Debian 12 container and stage install
        run: |
          set -eux
          docker run --rm -v "$PWD:/work" -w /work debian:12 bash -lc '
            set -euxo pipefail

            # ----------------------------
            # Base build deps
            # ----------------------------
            apt-get update
            apt-get install -y --no-install-recommends \
              ca-certificates curl wget gnupg lsb-release \
              git build-essential cmake ninja-build pkg-config \
              libssl-dev zlib1g-dev libbz2-dev libreadline-dev libncurses-dev \
              libboost-all-dev libcurl4-openssl-dev libgmp-dev

            # ----------------------------
            # Oracle MySQL 8 dev headers
            #
            # MySQL repo key is currently rejected in CI (EXPKEYSIG),
            # so we mark repo as trusted ONLY for this CI container.
            # ----------------------------
            echo "deb [trusted=yes] http://repo.mysql.com/apt/debian/ bookworm mysql-8.0" \
              > /etc/apt/sources.list.d/mysql.list

            apt-get update -o Acquire::AllowInsecureRepositories=true -o Acquire::AllowDowngradeToInsecureRepositories=true

            apt-get install -y --no-install-recommends \
              default-mysql-client libmysqlclient-dev

            # sanity
            ls -lah /usr/include/mysql || true
            mysql_config --version || true

            # ----------------------------
            # Fetch source
            # ----------------------------
            rm -rf /work/src /work/stage
            git clone https://github.com/mod-playerbots/azerothcore-wotlk.git --branch=Playerbot --single-branch /work/src
            rm -rf /work/src/modules/mod-playerbots
            git clone https://github.com/mod-playerbots/mod-playerbots.git /work/src/modules/mod-playerbots

            # ----------------------------
            # Build (avoid PCH + force include <utility> for std::exchange)
            # ----------------------------
            mkdir -p /work/src/build
            cd /work/src/build

            cmake .. -GNinja \
              -DCMAKE_INSTALL_PREFIX=/opt/azerothcore \
              -DMODULES=dynamic \
              -DSCRIPTS=static \
              -DENABLE_PCH=OFF \
              -DCMAKE_CXX_FLAGS="-include utility -Wno-error -Wno-stringop-overread" \
              -DCMAKE_C_FLAGS="-Wno-error"

            ninja

            # ----------------------------
            # Stage install for artifact
            # ----------------------------
            mkdir -p /work/stage
            DESTDIR=/work/stage ninja install

            # Hard checks (fail if missing)
            test -f /work/stage/opt/azerothcore/bin/worldserver
            test -f /work/stage/opt/azerothcore/bin/authserver
            ls -lah /work/stage/opt/azerothcore/bin
            ls -lah /work/stage/opt/azerothcore/modules || true
          '

      - name: Upload staged install as artifact
        uses: actions/upload-artifact@v4
        with:
          name: acore-stage
          path: stage/
